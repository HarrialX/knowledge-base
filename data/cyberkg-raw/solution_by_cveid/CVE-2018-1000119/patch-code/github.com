Original Source:
https://github.com/sinatra/sinatra/commit/8aa6c42ef724f93ae309fb7c5668e19ad547eceb#commitcomment-27964109

Commit history:

  @@ -23,8 +23,8 @@ def accepts?(env)
   session = session env
   token = session[:csrf] ||= session['_csrf_token'] || random_string
   safe?(env) ||
-  env['HTTP_X_CSRF_TOKEN'] == token ||
-  Request.new(env).params[options[:authenticity_param]] == token
+  secure_compare(env['HTTP_X_CSRF_TOKEN'], token) ||
+  secure_compare(Request.new(env).params[options[:authenticity_param]], token)
   end
   end
   end
  
  @@ -1,4 +1,5 @@
  require 'rack/protection'
+ require 'rack/utils'
  require 'digest'
  require 'logger'
  require 'uri'
  @@ -110,6 +111,10 @@ def encrypt(value)
   options[:encryptor].hexdigest value.to_s
   end
  
+  def secure_compare(a, b)
+  Rack::Utils.secure_compare(a.to_s, b.to_s)
+  end
+ 
   alias default_reaction deny
  
   def html?(headers)
  
