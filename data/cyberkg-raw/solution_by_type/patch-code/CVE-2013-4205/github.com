Original Source:
https://github.com/torvalds/linux/commit/6160968cee8b90a5dd95318d716e31d7775c4ef3

Commit history:

  @@ -105,16 +105,21 @@ int create_user_ns(struct cred *new)
  int unshare_userns(unsigned long unshare_flags, struct cred **new_cred)
  {
   struct cred *cred;
+  int err = -ENOMEM;
  
   if (!(unshare_flags & CLONE_NEWUSER))
   return 0;
  
  	cred = prepare_creds();
-  if (!cred)
-  return -ENOMEM;
+  if (cred) {
+ 		err = create_user_ns(cred);
+  if (err)
+  put_cred(cred);
+  else
+ 			*new_cred = cred;
+ 	}
  
- 	*new_cred = cred;
-  return create_user_ns(cred);
+  return err;
  }
  
  void free_user_ns(struct user_namespace *ns)
  
