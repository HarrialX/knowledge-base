Original Source:
https://github.com/cydrobolt/polr/commit/b1981709908caf6069b4a29dad3b6739c322c675

Commit history:

  @@ -3,6 +3,7 @@
  use Illuminate\Http\Request;
  use Illuminate\Http\Redirect;
  use Illuminate\Support\Facades\Artisan;
+ use Illuminate\Support\Facades\Schema;
  
  use App\Helpers\CryptoHelper;
  use App\Models\User;
  @@ -218,8 +219,8 @@ public static function performSetup(Request $request) {
      }
  
   public static function finishSetup(Request $request) {
-  // get data from cookie, decode JSON
   if (!isset($_COOKIE['setup_arguments'])) {
+  // Abort if setup arguments are missing.
   abort(404);
          }
  
  @@ -229,12 +230,19 @@ public static function finishSetup(Request $request) {
   // unset cookie
   setcookie('setup_arguments', '', time()-3600);
  
-  $transaction_authorised = env('TMP_SETUP_AUTH_KEY') == $setup_finish_args->setup_auth_key;
+  $transaction_authorised = env('TMP_SETUP_AUTH_KEY') === $setup_finish_args->setup_auth_key;
  
   if ($transaction_authorised != true) {
   abort(403, 'Transaction unauthorised.');
          }
  
+  $usersTableExists = Schema::hasTable('users');
+ 
+  if ($usersTableExists) {
+  // If the users table exists, then the setup process may have already been completed before.
+  abort(403, 'Setup has been completed already.');
+         }
+ 
   $database_created = self::createDatabase();
   if (!$database_created) {
   return redirect(route('setup'))->with('error', 'Could not create database. Perhaps your credentials were incorrect?');
  
  @@ -14,7 +14,7 @@
   "torann/geoip": "^1.0",
   "geoip2/geoip2": "^2.4",
   "nesbot/carbon": "^1.22",
-  "doctrine/dbal": "^2.5",
+  "doctrine/dbal": "2.5.11",
   "google/recaptcha": "~1.1",
   "symfony/http-foundation": "2.7.51"
      },
  
