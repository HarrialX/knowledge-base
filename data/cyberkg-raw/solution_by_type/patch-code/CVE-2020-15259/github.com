Original Source:
https://github.com/auth0/ad-ldap-connector/commit/8b793631ec5ecacf63ff3ece23231a9e138ae911

Commit history:

  @@ -86,6 +86,7 @@
   $('#profile-mapper-alerts').html('');
  
   $.post('/profile-mapper', {
+  _csrf: document.getElementById('csrf').value,
   code: code.getValue()
   }).always(function() {
   btn.button('reset');
  @@ -131,7 +132,9 @@
   $("#logs-clear").click(function(e) {
   e.preventDefault();
  
-  $.post('/logs/clear');
+  $.post('/logs/clear', {
+  _csrf: document.getElementById('csrf').value
+  });
   $('#logs').text('');
   });
  
  @@ -238,7 +241,9 @@
   $("#update-run-form").submit(function(e) {
   e.preventDefault();
  
-  $.post('/updater/run');
+  $.post('/updater/run', {
+  _csrf: document.getElementById('csrf').value,
+  });
  
   update = 'Started';
   $('#update-logs').text('');
  
  @@ -5,6 +5,7 @@ var unzipper = require('unzipper');
  var path = require('path');
  var archiver = require('archiver');
  var cas = require('../lib/add_certs');
+ var csrf = require('csurf');
  var os = require('os');
  var fs = require('fs');
  var http = require('http');
  @@ -31,7 +32,7 @@ app.use(cookieParser());
  app.use(session({
   secret: 'sojo sut ed oterces le'
  }));
- 
+ var csrfProtection = csrf({ cookie: true });
  var detected_settings = {};
  
  if (process.platform === 'win32') {
  @@ -113,18 +114,20 @@ function run(cmd, args, callback) {
   });
  }
  
- app.get('/', set_current_config, function(req, res) {
+ app.get('/', set_current_config, csrfProtection, function(req, res) {
   console.log(req.session.LDAP_RESULTS);
   res.render('index', xtend(req.current_config, {
   SUCCESS: req.query && req.query.s === '1',
   LDAP_RESULTS: req.session.LDAP_RESULTS
   }, {
   detected: detected_settings
+  }, {
+  csrfToken: req.csrfToken()
   }));
   delete req.session.LDAP_RESULTS;
  });
  
- app.post('/ldap', set_current_config, function(req, res, next) {
+ app.post('/ldap', set_current_config, csrfProtection, function(req, res, next) {
   // Convert ENABLE_WRITE_BACK and ENABLE_ACTIVE_DIRECTORY_UNICODE_PASSWORD to boolean.
   req.body.ENABLE_WRITE_BACK = !!(req.body.ENABLE_WRITE_BACK && req.body.ENABLE_WRITE_BACK === 'on');
   req.body.ENABLE_ACTIVE_DIRECTORY_UNICODE_PASSWORD = !!(req.body.ENABLE_ACTIVE_DIRECTORY_UNICODE_PASSWORD && req.body.ENABLE_ACTIVE_DIRECTORY_UNICODE_PASSWORD === 'on');
  @@ -149,7 +152,7 @@ app.post('/ldap', set_current_config, function(req, res, next) {
   });
  }, merge_config);
  
- app.post('/server', multipart(), set_current_config, function(req, res, next) {
+ app.post('/server', multipart(), set_current_config, csrfProtection, function(req, res, next) {
   if (req.body.PORT || req.current_config.PORT) return next();
   freeport(function(er, port) {
   req.body.PORT = port;
  @@ -165,7 +168,7 @@ app.post('/server', multipart(), set_current_config, function(req, res, next) {
   });
  }, merge_config);
  
- app.post('/ticket', set_current_config, function(req, res, next) {
+ app.post('/ticket', set_current_config, csrfProtection, function(req, res, next) {
   if (!req.body.PROVISIONING_TICKET) {
   return res.render('index', xtend(req.current_config, {
   ERROR: 'The ticket url ' + req.body.PROVISIONING_TICKET + ' is not vaild.'
  @@ -257,7 +260,7 @@ app.get('/export', set_current_config, function(req, res) {
   archive.finalize();
  });
  
- app.post('/import', set_current_config, multipart(), function(req, res, next) {
+ app.post('/import', set_current_config, csrfProtection, multipart(), function(req, res, next) {
   console.log('Importing configuration.');
  
   if (!req.files || !req.files.IMPORT_FILE || req.files.IMPORT_FILE.size === 0) {
  @@ -312,7 +315,7 @@ app.get('/logs', function(req, res) {
   });
  });
  
- app.post('/logs/clear', function(req, res) {
+ app.post('/logs/clear', csrfProtection, function(req, res) {
   fs.writeFile(__dirname + '/../logs.log', '', function(err) {
   if (err) {
   res.status(500);
  @@ -349,7 +352,7 @@ app.get('/profile-mapper', function(req, res) {
   });
  });
  
- app.post('/profile-mapper', function(req, res) {
+ app.post('/profile-mapper', csrfProtection, function(req, res) {
   fs.writeFile(__dirname + '/../lib/profileMapper.js', req.body.code, function(err) {
   if (err) {
   res.status(500);
  @@ -440,7 +443,7 @@ app.get('/troubleshooter/export', set_current_config,
   archive.finalize();
   });
  
- app.post('/updater/run', set_current_config, function(req, res) {
+ app.post('/updater/run', csrfProtection, set_current_config, function(req, res) {
   run(__dirname + '/../update-connector.cmd', [], function(data) {
   res.writeHead(200, {
   "Content-Type": "text/plain"
  
  @@ -1,4 +1,5 @@
  <form class="form-horizontal ldap" method="post" action="/ldap">
+   <input type="hidden" id="csrf" name="_csrf" value="<%= locals.csrfToken %>">
    <p>
      Please enter the settings to connect to your LDAP.
      This will be saved locally and never send exposed.
  
  @@ -1,6 +1,6 @@
- <form method="post" action="/import" enctype="multipart/form-data">
+ <form method="post" action="/import?_csrf=<%= locals.csrfToken %>" enctype="multipart/form-data">
    <p>
-     Import a previous configuration to the connector. 
+     Import a previous configuration to the connector.
    </p>
  
    <div class="control-group" style="border-top:0px;">
  @@ -17,4 +17,4 @@
        <button type="submit" class="btn btn-primary">Upload</button>
      </div>
    </div>
- </form>
+ </form>
  @@ -1,4 +1,5 @@
  <form class="form-horizontal" method="post" action="/server" enctype="multipart/form-data">
+   <input type="hidden" id="csrf" name="_csrf" value="<%= locals.csrfToken %>">
    <div class="control-group">
      <label class="control-label" for="SERVER_URL">Front Facing URL:</label>
      <div class="controls">
  @@ -61,7 +62,7 @@
        <span class="help-block">A string of passphrase for the pfx</span>
      </div>
    </div>
-  
+ 
    <div class="control-group">
      <label class="control-label" for="CA_CERT">CA Certificate(s):</label>
      <div class="controls">
  @@ -84,4 +85,4 @@ CA #2...
        <button type="submit" class="btn btn-primary">Save</button>
      </div>
    </div>
- </form>
+ </form>
  @@ -1,4 +1,5 @@
  <form class="form-horizontal" method="post" action="/ticket">
+   <input type="hidden" id="csrf" name="_csrf" value="<%= locals.csrfToken %>">
    <p>
      Please enter the ticket url as shown in the instructions provided in the documentation
    </p>
  @@ -23,4 +24,4 @@
        <button type="submit" class="btn btn-success">Continue</button>
      </div>
    </div>
- </form>
+ </form>
  @@ -20,6 +20,7 @@
    <div class="wrapper">
      <div id="tmp-dialogs"></div>
      <div id="content" style="margin-left: 0;">
+       <input type="hidden" id="csrf" name="_csrf" value="<%= locals.csrfToken %>">
        <section id="configuration-section" class="content-page current">
          <div id="content-header">
          <h1>AD LDAP Connector <span id="connector-version"></span> Configuration</h1>
  
  @@ -1,6 +1,6 @@
  {
   "name": "ad-ldap-connector",
-  "version": "5.0.12",
+  "version": "5.0.13",
   "description": "ADLDAP Federation Connector",
   "main": "server.js",
   "scripts": {
  @@ -32,6 +32,7 @@
   "connect-multiparty": "^2.2.0",
   "cookie-parser": "^1.4.3",
   "cookie-sessions": "github:auth0/cookie-sessions#53a8aae",
+  "csurf": "1.9.0",
   "ejs": "^2.5.5",
   "express": "^4.16.4",
   "express-passport-logout": "~0.1.0",
  
